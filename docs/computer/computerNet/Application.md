---
title: 应用层详解
data: 2021-05-29
categories:
- 计算机网络
tags:
- 计算机网络
---
# 概述
应用层的**功能**：
* 文件传输、访问和管理
* 电子邮件
* 虚拟终端
* 查询服务和远程作业登录
## 客户机与服务器c/s模型
**服务器**：提供计算服务的设备。
1. 永久提供服务
2. 永久性访问地址/域名
**客户机**：请求计算服务的主机。
1. 与服务器通信，使用服务器提供的服务
2. 间歇性接入网络
3. 可能使用动态P地址
4. 不与其他客户机直接通信
## p2p模型
1. 不存在永远在线的服务器
2. 每个主机既可以提供服务，也可以请求服务
3. 任意端系统/节点之间可以直接通讯
4. 节点间歇性接入网络
5. 节点可能改变P地址
6. 可扩展性好
7. 网络健壮性强
# DNS
DNS 是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。
* 域名：www.panther9985.icu
顶级域名icu：
1. 国家顶级域名：cn us uk等
2. 通用顶级域名：com net icu等
3. 反向域名：arpa
二级域名：
panther9985等
三级域名：
www、mail等
# FTP
* FTP文件传输协议
* TDTP简单文件传输协议
## FTP的连接模式
* FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：
1. 控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
2. 数据连接：用来传送一个文件数据。
根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：
* 主动模式：**服务器端**主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/03f47940-3843-4b51-9e42-5dcaff44858b.jpg)
* 被动模式：**客户端**主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/be5c2c61-86d2-4dba-a289-b48ea23219de.jpg)
:::warning
主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。
:::
## FTP传输模式
* 文本模式：ASCII模式，以文本序列传输数据：
* 二进制模式：Binary模式，以二进制序列传输数据。
# 电子邮件协议
一个电子邮件系统由三部分组成：`用户代理`、`邮件服务器`以及`邮件协议`
邮件协议包含**发送协议**和**读取协议**，发送协议常用 `SMTP`，读取协议常用 `POP3` 和 `IMAP`
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7b3efa99-d306-4982-8cfb-e7153c33aab4.png)
## SMTP
* SMTP规定了在两个相互通信的SMTP进程之间应如何交换信息。
* 负责发送邮件的SMTP进程就是SMTP客户，负责接收邮件的进程就是SMTP服务器。
:::info
SMTP通信过程
:::
* 采用TCP传输、端口号25、采用C/S连接
![](https://pic.imgdb.cn/item/626e5f4f239250f7c583609c.png)
:::warning
SMTP的缺点：
:::
1. SMTP不能传送可执行文件或者其他二进制对象。
2. SMTP仅限于传送7位ASC码，不能传送其他非英语国家的文字。
3. SMTP服务器会拒绝超过一定长度的邮件。
## MIME
* 互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则
* 使电子邮件系统可以支持声音、图像、视频、多种国家语言等等。使得传输内容丰富多彩
![](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ed5522bb-3a60-481c-8654-43e7195a48fe.png)
## POP3
POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。但最新版本的 POP3 可以不删除邮件。
* 采用TCP传输、端口号110、采用C/S连接
## IMPA
* IMAP协议比POP协议复杂。当用户PC上的IMAP客户程序打开IMAP服务器的邮箱时，用户可以看到邮箱的首部，若用户需要打开某个邮件，该邮件才上传到用户的计算机上。
* IMAP 协议中**客户端和服务器上的邮件保持同步**，如果不手动删除邮件，那么服务器上的邮件也不会被删除。
IMAP 这种做法可以让用户**随时随地去访问**服务器上的邮件。
# 万维网(www)
* 是一个大规模的、联机式的信息储藏所/资料空间，是无数个网络站点和网页的集合。
统一资源定位符`URL`唯一标识---->>[资源]{.label .info}（文字、视频、音频…)
URL格式：<协议>://<主机>:<端口>/<路径>
* 协议：http、https、ftp等
* 主机：域名、IP地址
万维网使用超文本标记语言[**HTML**]{.red},
使得万维网页面设计者可以很方便地从一个界面的链接转到另一个界面，并能够在自己的屏幕上显示出来。
## 向请求文档过程
HTTP协议定义了浏览器（万维网客户进程）怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。
![](https://pic.imgdb.cn/item/626e5f64239250f7c58390b0.png)
[具体过程]{.label .info}：
1. 浏览器分析URL
2. 浏览器向DNS请求解析IP地址
3. DNS解析出IP地址
4. 浏览器与服务器建立TCP连接
5. 浏览器发出取文件命令
6. 服务器响应
7. 客户端取文件
8. 释放TCP连接
9. 浏览器显示
## http协议特点
* http协议是**无状态**的
* `Cookie`是存储在用户主机中的文本文件，记录一段时间内用户(使用识别码识别，如“123456”)的访问记录。
:::info
状态码
:::
* `1xx`表示通知信息的，如请求收到了或正在处理。
* `2xx`表示成功x如接受或知道了。
* `3xx`表示重定向，如要完成请求还必须采取进一步的行动。
* `4xx`表示客户的差错，如请求中有错误的语法或不能完成。
* `5xx`表示服务器的差错，如服务器失效无法完成请求。
# WEB页面请求过程详解
## DHCP 配置主机信息
1. 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用`DHCP`来获取。

2. 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的`UDP`报文段中。

3. 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。

该数据报则被放置在`MAC`帧中，该帧具有目的地址 FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF,**将广播到与交换机连接的所有设备**

4. 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：**IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码**。该报文被放入 UDP 报文段中，UDP 报文段又被放入 IP 数据报中，最后放入`MAC`帧中。

5. 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

6. 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。
## ARP解析MAC地址
1. 主机通过浏览器生成一个`TCP`套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

2. 主机生成一个`DNS`查询报文，该报文具有53号端口，因为`DNS`服务器的端口号是 53。

3. 该DNS查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

4. 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

5. DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

6. 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址(FF:< zero-width space> FF:< zero-width space> FF:< zero-width space> FF:< zero-width space>FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机**将该帧转发给所有的连接设备**，包括网关路由器。

7. 网关路由器接收到该帧后，不断向上**分解得到 ARP 报文**，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

## DNS解析域名
1. 知道了网关路由器的 MAC 地址之后，就可以继续`DNS`的解析过程了。

2. 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

3. 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

4. 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

5. 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。
## HTTP 请求页面
1. 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于**向 Web 服务器发送 HTTP GET 报文。**

2. 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行**三次握手**来建立连接。生成一个具有目的端口`80`的 TCP `SYN` 报文段，并向 HTTP 服务器发送该报文段。

3. HTTP 服务器收到该报文段之后，生成 `TCP` `SYN` `ACK` 报文段，发回给主机。

4. 连接建立之后，浏览器生成 HTTP GET 报文，并**交付给 HTTP 服务器**。

5. HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，**将 Web 页面内容放入报文主体中，发回给主机。**

6. 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，**显示 Web 页面**。