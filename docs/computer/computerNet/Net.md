---
title: 网络层详解
data: 2021-05-29
categories:
- 计算机网络
tags:
- 计算机网络
---
# 网络层
主要任务是把[分组]{.red}从源端传到目的端，为[分组]{.red}交换网上的不同主机提供通信服务。网络层传输单位是数据报。
功能一：路由选择与分组转发 [最佳路径]{.red}
功能二：异构网络互联
功能三：拥塞控制
若所有结点都来不及接受分组，而要丢弃大量分组的话，网络就处于[拥塞]{.green}状态。因此要采取定措施，缓解这种拥塞。
* 开环控制（静态）
* 闭环控制（动态）
# 数据交换方式
## 电路交换
特点：**独占资源**
[建立连接]{.yellow}-->[通信]{.green}-->[释放连接]{.blue}
优点：
1. 通信时延小
2. 有序传输
3. 没有冲突
4. 实时性强
缺点：
1. 建立连接时间长
2. 线路独占，使用效率低
3. 灵活性差
4. 无差错控制能力
## 报文交换
[报文]{.red}：[源应用发送的信息整体]{.label .info}
优点：
1. 无需建立连接
2. 存储转发，动态分配线路
3. 线路可靠性较高
4. 线路利用率较高
5. 多目标服务
缺点：
1. 有存储转发时延
2. 报文大小不定，需要网络节点有较大缓存空间
## 分组交换
分组：把大的数据块分割成小的数据块。
优点：
1. 无需建立连接
2. 存储转发，动态分配线路
3. 线路可靠性较高
4. 线路利用率较高
5. 相对于报文交换，存储管理更容易
缺点：
1. 有存储转发时延
2. 需要传输额外的信息量
3. 乱序到目的主机时，要对分组排序重组
## 三种交换方式对比
1. 报文交换和分组交换都采用存储转发。
2. 传送数据量大，且传送时间远大于呼叫时，选择电路交换。电路交换传输时延最小。
3. 从信道利用率看，报文交换和分组交换优于电路交换，其中分组交换时延更小。
![](https://pic.imgdb.cn/item/626e5d1a239250f7c57d772a.png)
# 子网
## 子网掩码
:::info
二级IP地址的子网掩码
:::
二级IP地址的构成：[网络号]{.red}[主机号]{.blue}
子网掩码：将网络号全写1，主机号全为零，**例如192.168.0.1的子网掩码为255.255.0.0**
:::info
三级IP地址的子网掩码
:::
二级IP地址的构成：[网络号]{.red}[子网号]{.yellow}[主机号]{.blue}
主机号不能全零也不能全一
子网掩码：将网络号和子网号全写1，主机号全为零，**例如192.168.0.1的子网掩码为255.255.255.0**
## 子网网络地址
* 子网掩码与IP地址逐位相与就得到子网网络地址
**已知IP地址是141.14.72.24，子网掩码是255.255.192.0，求网络地址**
+++info
将子网掩码写成二进制位：11111111.11111111.11000000.000000,根据子网掩码可以判段出，IP地址为三级地址网络号16位，子网号2位，主机号14位，
将IP地址写成二进制10001101.00001110.01001000.00011000
最后将IP地址与子网掩码相与141.14.64.0
+++
**某主机的1P地址为180.80.77.55，子网掩码为255.255.252.0。若该主机向其所在子网发送广播分组，则目的地址可以是()**
A.180.80.76.0    B.180.80.76.255    C.180.80.77.255    D.180.80.79.255
+++info
根据子网掩码可以判断前22位为子网号，将子网号与子网掩码相与得到子网网络地址为180.80.76.0广播地址将后面的主机号全值结果为180.80.79.255
+++
## 无分类编码CIDR
* CIDR的格式：192.168.1.0/20指定前20位为子网
消除了子网划分的概念
**192.199.170.82/27的最大子网地址和最小子网概念**
+++info
将前27位地址取出不变将剩下的5位地址全取0为最小，全取1为最大
最小：192.199.170.64
最大：192.199.170.95
+++
**最长匹配前缀**
使用CIDR时，查找路由表可能得到几个匹配结果，应选择具有最长网络前缀的路由。前缀越长，地址块越小
路由越具体。
# 网络层协议
在TCP/IP体系结构的网际互连层，最重要的协议就是**IP协议簇**
* 目前主流的IPv4协议簇中包括了三个协议：
1. IP（Internet Protocol，因特网协议）
2. ARP（Address Resolution Protocol，地址解析协议）
3. ICMP（Internet Control Message Protocol，因特网控制消息协议）
4. DHCP
* IPv6协议簇中包括了四个协议：
* IPv6
* IGMP
* ND（Neighbor Discovery，邻居发现）协议
* MLD（Multicast Listener Discover，组播侦听器发现）协议
## IPv4协议簇
IP协议是一个**无连接**的服务，负责在源地址和目的地址之间传送数据报。IP协议的主要功能就是把数据报在互连的网络上传送
:::info
功能
:::
1. 寻址
在常用的IP网络中运行的三层协议就是IP协议，对应的三层地址就是IP地址
2. 据报的封装
在IP网络中，从传输层到达的数据段都需要经过IP协议进行重新封装的
3. 分段与重组
报文的最大传输单元(MTU),超出这个最大存储单元的数据报，需要拆分成多个小段的数据报再依次传输出去，重装把这些被拆分的分段重新组合起来。
:::info
缺点
::: 
1. IPv4地址空间面临枯竭
2. 骨干路由器维护的路由表表项数量过多
3. 配置复杂
4. 服务质量差
5. 不支持端到端安全
## ARP协议
ARP协议：完成主机或路由器IP地址到MAC地址的映射。
ARP高速缓存(IP地址与MAC地址的映射)
ARP协议使用过程：
1. 检查ARP高速缓存，有对应项则写入MAC帧，没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封装
2. 广播ARP请求分组，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源
主机单播一个ARP响应分组，源主机收到后将此映射写入ARP缓存(10-20min更新一次)。
:::info
发送数据的过程
:::
![](https://pic.imgdb.cn/item/626e5d59239250f7c57e11ef.png)
## DHCP协议
DHCP提供即插即用联网的机制，主机可以从**服务器**动态获取**IP地址、子网掩码、默认网关、DNS服务器名称与IP地址**，允许地址重用，支持移动用户加入网络，支持在用地址续租。
动态主机配置协议DHCP是[应用层]{.red}协议，使用[客户/服务]{.red}器方式，客户端和服务端通过
[广播]{.red}方式进行交互，基于[UDP]{.red}。
DHCP使用过程
1. 主机广播DHCP发现报文
2. DHCP服务器广播DHCP提供报文
3. 主机广播DHCP请求报文
4. DHCP服务器广播DHCP确认报文
## ICMP协议
**ICMP差错报文**
1. 终点不可达：当路由器或主机不能交付数据报时就向源点发送终点不可达报文。
2. 时间超过：当路由器收到生存时间TTL=0的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当
终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。TTL=0
3. 参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。首部字段有问题
4. 改变路由（重定向)：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)
**不应发送ICMP差错报文的情况**
1. 对ICMP差错报告报文不再发送ICMP差错报告报文。
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
3. 对具有组播地址的数据报都不发送ICMP差错报告报文。
4. 对具有特殊地址（如127.0.0.0或0.0.0.0)的数据报不发送ICMP差错报告报文。
**ICMP询问报文**
1. 回送请求和回答报文
主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由
器发送ICMP回送回答报文。[测试目的站是否可达以及了解其相关状态 eg:ping]{.red}
2. 时间戳请求和回答报文请某个主机或路由器回答当前的日期和时间。[用来进行时钟同步和测量时间]{.red}
**ICMP的常应用**
==PING==
测试两个主机之间的连通性，使用了ICMP回送请求和回答报文。
==Traceroute==
跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。
# IPv6协议簇
IPv6地址的基本表达方式是x：x：x：x：x：x：x：x，其中的一个“x”是一个4个十六进制整数
## RIP
RIP是一种分布式的基于[距离向量]{.red}的路由选择协议，是因特网的协议标准，最大优点是**简单**。
RIP协议要求网络中每一个路由器都维护从它自己到其他每一个目的网络的唯一最佳距离记录(即一组距离)
RIP允许一条路只能包含15个路由器只适用小互联网
* RIP协议好消息传得快，坏消息传得慢
## OSPF协议
开放最短路径优先OSPF协议：“开放”标明OSPF协议不是受某一家厂商控制，而是公开发表的：“最短路径优先”是因为使用了Dijkstra提出的**最短路径算法SPF**。
OSPF最主要的特征就是使用分布式的链路状态协议。
:::info
特点
:::
1. 使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。
2. 发送的信息就是与本路由器**相邻的所有路由器**的链路状态（本路由器和哪些路由器相邻，以及该链路的度
量/代价一一费用、距离、时延、带宽等)。
3. 只有当**链路状态发生变化**时，路由器才向所有路由器洪泛发送此信息。
## BGP协议
BGP支持CIDR,因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
在BGP刚刚运行时，BGP的邻站是交换整个的BGP路由表。但以后只需要在**发生变化时更新有变化的部分**。这样做对节省网络带宽和减少路由器的处理开销都有好处。
:::info
BGP-4报文
:::
1. `OPEN`(打开)报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方。
2. `UPDATE`(更新)报文：通告新路径或撤销原路径。
3. `KEEPALIVE`(保活)报文：在无UPDATE时，周期性证实邻站的连通性；也作为OPEN的确认。
4. `NOTIFICATION`(通知)报文：报告先前报文的差错；也被用于关闭连接。
# 三种路由协议比较
| 协议 | 网关 | 传输协议 | 路由算法 | 交换节点 |
|-|-|-|-|-|
| RIP | 内部网关 | UDP | 距离-向量 | 和本节点相邻的路由器 |
| OSPF |内部网关 | 直接采用IP | 链路状态 | 网络中所以路由器 |
| BGP | 外部网关 | TCP | 路径-向量 | 和本节点相邻的路由器 |
# IP数据报的三种传输方式
:::info
* 单播
:::
用于发送数据包到单个目的地，且每发送一份单播报文都使用一个单播IP地址作为目的地址。是一种点对点传输方式。
:::info
广播
:::
是指发送数据包到同一广播域或子网内的所有设备的一种数据传输方式，是一种点对多点传输方式。
:::info
组播
:::
当网络中的某些用户需要特定数据时，组播数据发送者仅发送一次数据，借助组播路由协议为组播数据包建立组播分发树，被传递的数据到达距离用户端尽可能近的节点后才开始复制和分发，是一种点对多点传输方式。
* 广播和组播的区别：广播发给所有用户，而组播发给特定用户
## IGMP协议
IGMP协议让路由器知道本局域网上是**否有主机（的进程）参加或退出了某个组播组**
**两个阶段**
1. 某主机要加入组播组时，该主机向组播组的组播地址发送一个IGMP报文，声明自己要称为该组的成员：
本地组播路由器收到IGMP报文后，要利用组播路由选择协议把这组成员关系发给因特网上的其他组播路由器
2. 本地组播路由器周期性探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员。
只要有一个主机对某个组响应，那么组播路由器就认为这个组是活跃的：如果经过几次探询后没有一个主机响应，组播路由器就认为本网络上的没有此组播组的主机，因此就不再把这组的成员关系发给其他的组播路由器。
# 路由器
* 路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。其内部主要由路由选择分组转发组成
:::info
路由组合
:::
根据所选定的路由选择协议[构造出路由表]{.red}，同时经常或定期地和相邻路由器交换路由信息而不断地[更新和维护路由表]{.red}。
:::info
分组转发
:::
交换结构：根据**转发表**（路由表得来)对分组进行转发。
## 三个设备的区别
[路由器]{.green}： 可以互联两个不同网络层协议的网段。
[网桥]{.green}:   可以互联两个物理层和链路层不同的网段。
[集线器]{.green}: 不能互联两个物理层不同的网段。